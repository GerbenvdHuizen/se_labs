<!--
	Software Evolution - University of Amsterdam
	Practical Lab Series 2 - Clone Detection
	index.html

	Vincent Erich - 10384081
	Gerben van der Huizen - 10460748
	December 2016
	
	Source for 'virtualscroller.js':
	http://bl.ocks.org/billdwhite/36d15bc6126e6f6365d0#virtualscroller.js
-->

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title></title>
        <script type="text/javascript" src="js/D3/d3.v3.js"></script>
		<script src="virtualscroller.js"></script>
        <style>
		body{
            font-family:"Arial";
			width: 1600px;
            height: 800px;
		}
		
		.buttontext text,
		.background text,
		.buttonGroup text,
		.mono text,
		.legend text,
		.row text,
		.column text {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		
		.svg {
			pointer-events: none;
		}
		
		.row rect,
		.column rect,
		.cell rect {
			shape-rendering: geometricPrecision;
		}
		
		div.tooltip {	
			position: absolute;			
			text-align: center;			
			width: auto;					
			height: auto;					
			padding: 2px;				
			font: 12px sans-serif;		
			background: lightsteelblue;	
			border: 0px;		
			border-radius: 8px;			
			pointer-events: none;			
		}
		
		.viewport {
            position: absolute;
            top: 15px;
            left: 15px;
            overflow-y: auto;
            width: 1570px;
            height: 775px;
            background-color: #e8e8e8;
            border: 1px solid #AAAAAA;
            border-radius: 4px;
            box-shadow: inset 1px 1px 6px 2px rgba(0,0,0, .25);
        }
		
		.detailview {
           position: absolute;
            top: 15px;
            left: 15px;
            overflow-y: auto;
            width: auto;
            height: auto;
            background-color: #e8e8e8;
            border: 1px solid #AAAAAA;
            border-radius: 4px;
            box-shadow: inset 1px 1px 6px 2px rgba(0,0,0, .25);	
        }

		</style>
    </head>
<body>
<div class="viewport"></div>
<script>
	
	///////////////////
	// Read CSV file //
	///////////////////

	d3.text("../csv/cloneDataFiles.csv", function(text) {
		var parsedData = d3.csv.parseRows(text);
		var clonesFilesData = [];
		var fileArray = [];
		for (var i = 1; i < parsedData.length; i++) {
			fileArray.push(parsedData[i][0]);
			clonesFilesData.push([parsedData[i][0], parsedData[i][1], parseInt(parsedData[i][2]),parsedData[i][3].toString()]);
		}
		
		///////////////////////
		//	Helper functions //
		///////////////////////
		
		// Get unique items from array.
		function uniq(a) {
			var seen = {};
			return a.filter(function(item) {
				return seen.hasOwnProperty(item) ? false : (seen[item] = true);
			});
		}
		
		// Fill a matrix with data.
		function fillMatrix(first, second) {
			var x = [0,"",""];
			for (var i = 0; i < clonesFilesData.length; i++) {
				if (clonesFilesData[i][0] == first && clonesFilesData[i][1] == second) {
					x = [clonesFilesData[i][2], first, second, clonesFilesData[i][3]];
				}
			}
			return x;
		}
		// sort a today array by the column/index of an element.
		function sortByColumn(a, colIndex){

			a.sort(sortFunction);

			function sortFunction(a, b) {
				if (a[colIndex] === b[colIndex]) {
					return 0;
				}
				else {
					return (a[colIndex] > b[colIndex]) ? -1 : 1;
				}
			}

			return a;
		}
		
		// Sort matrix by columns and rows.
		function sortMatrix(inputMatrix) {
			sortedMatrix = [];
			counter = 0
			for (var i = 0; i < inputMatrix.length; i++) {
				counter+=1;
				sortedMatrix.push([]);
				for (var j = 0; j < inputMatrix.length; j++) {
					sortedMatrix[i].push([]);
				}
			}
		
			sortedMatrix2 = [];
			for (var i = 0; i < inputMatrix.length; i++) {
				sortedMatrix2.push([]);
			}
			
			columnSums = [];
			for (var i = 0; i < inputMatrix.length; i++) {
				columnSum = 0;
				for (var j = 0; j < inputMatrix.length; j++) {
					columnSum += inputMatrix[j][i][0];
				}
				columnSums.push([columnSum,i]);
			}
			newColumn = sortByColumn(columnSums, 0);
			for (var i = 0; i < inputMatrix.length; i++) {
				for (var j = 0; j < inputMatrix.length; j++) {
					sortedMatrix[i][j] = inputMatrix[i][newColumn[j][1]];
				}
			}
			
			rowSums = [];
			
			for (var i = 0; i < inputMatrix.length; i++) {
				row = sortedMatrix[i];
				rowSum = 0;
				
				for (var j = 0; j < inputMatrix.length; j++) {
					rowSum += sortedMatrix[i][j][0];
				}
				rowSums.push([rowSum, i]);
				
			}
			newRow = sortByColumn(rowSums, 0);
			
			for (var i = 0; i < inputMatrix.length; i++) {
				sortedMatrix2[i] = sortedMatrix[newRow[i][1]];
			}
		
			return sortedMatrix2;
		}
		
		// Return a color code based on the integer input.
		function chooseColor(d) {
			color = "black";
			if (d[0] == 0)
				color = "white";
			else if (d[0] == 1)
				color = "#c7e9b4";
			else if (d[0] == 2)
				color = "#7fcdbb";
			else if (d[0] == 3)
				color = "#41b6c4";
			else if (d[0] >= 4 && d[0] < 15)
				color = "#1d91c0";
			else if (d[0] >= 15)
				color = "#225ea8";
			
			return color
		}
		
		/*
		function chooseColor(d) {
			color = "black";
			if (d[0] == 0)
				color = "#fee5d9";
			else if (d[0] == 1)
				color = "#fcbba1";
			else if (d[0] == 2)
				color = "#fc9272";
			else if (d[0] == 3)
				color = "#fb6a4a";
			else if (d[0] >= 4 && d[0] < 15)
				color = "#de2d26";
			else if (d[0] >= 15)
				color = "#a50f15";
			
			return color
		}
		*/
		// Determine font size.
		function fontSize(d) {
			fontSize = 10;
			if (d >= 80)
				fontSize = 7;
			return fontSize;
		}
		
		///////////////////////////
		// Important definitions //
		///////////////////////////
		
		var sorted = false;
		var detail = false;
		
		var uniqueFiles = uniq(fileArray);
		
		var margin = {top: 175, right: 15, bottom: 0, left: 350},
			width = 1400,
			height = 1000
			innerWidth = 2000
			innerHeight = 1500;
			
		var numrows = uniqueFiles.length;
		var numcols = uniqueFiles.length;
		var matrix = new Array(numrows);
		var fontSize = fontSize(uniqueFiles.length);
		
		for (var i = 0; i < numrows; i++) {
			matrix[i] = new Array(numcols);
			for (var j = 0; j < numcols; j++) {
				matrix[i][j] = fillMatrix(uniqueFiles[i], uniqueFiles[j]);
			}
		}
		
		var colors = ["white","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8"];
		var gridSize = Math.floor(height / 24);
		var legendElementWidth = gridSize*2;
		var rowLabels = new Array(numrows);
		
		var x = d3.scale.ordinal()
			.domain(d3.range(numcols))
			.rangeBands([0, innerWidth]);
			
		var y = d3.scale.ordinal()
			.domain(d3.range(numrows))
			.rangeBands([0, innerHeight]);
		
		/////////////////////////////////////
		// Define the visualization window //
		/////////////////////////////////////
		var svg = d3.select(".viewport").append("svg")
            .attr("class", "scroll-svg")
			.attr("width", innerWidth +  margin.left + margin.right)
			.attr("height", innerHeight + margin.top + margin.bottom)
			.style("margin-left", (-0.5* margin.left) + "px")
		  .append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
		svg.append("rect")
			.attr("class", "background")
			.attr("width", innerWidth)
			.attr("height", innerHeight);
			
		var restGroup = d3.select("body").append("svg")
			.attr("width", width + margin.left + 100)
			.attr("height", 800)
			.style("margin-left", (-0.5* margin.left) + "px")
		  .append("g")
			.attr("transform", "translate(" + margin.left + "," + "15" + ")")
			.style("fill", "white");
			
		///////////////////////////////////////////
		// Group of buttons and text for sorting //
		///////////////////////////////////////////
		
		var buttonGroup = restGroup.append("g").attr("class", "buttonGroup");
			
		var sortText = buttonGroup.append("text")
			.attr("class", "buttontext")
			.text("Sort by:")
			.attr("x", width *1.02)
			.attr("y", height * 0.51)
			.attr("dy", "" + .3 + "ex")
			.style("fill", "Black")
			.style("font-size",""+ width * 0.011 +"px");
		
		var clonesButton = buttonGroup.append("rect")
			.data(["clonesButton"])
			.attr("class", "button")
			.attr("x", width * 1.014)
			.attr("y", height * 0.528)
			.attr("rx", 5)
			.attr("ry", 5)
			.attr("width", width * 0.052)
			.attr("height", width * 0.022)
			.style("fill", "#EBFCFF")
			.style("stroke", "black")
			.style("opacity", 0.7)
			.style("cursor","pointer")
			.on("click", function() {loadSorted();
			});
			
		var clonesButtonText = buttonGroup.append("text")
			.attr("class", "buttontext")
			.text("# Pairs")
			.attr("x", width *1.022)
			.attr("y", height * 0.546)
			.attr("dy", "" + .3 + "ex")
			.style("font-size",""+ width * 0.011 +"px")
			.style("cursor","pointer")
			.style("fill", "Black")
			.on("click", function() {loadSorted();
			});
			
			
		var folderButton = buttonGroup.append("rect")
			.attr("class", "button")
			.attr("x", width * 1.014)
			.attr("y", height * 0.578)
			.attr("rx", 5)
			.attr("ry", 5)
			.attr("width", width * 0.052)
			.attr("height", width * 0.022)
			.style("fill", "#EBFCFF")
			.style("stroke", "black")
			.style("opacity", 0.7)
			.on("click", function(d,i){location.href = "folderView.html";})
			.style("cursor", "pointer");
			
		var folderButtonText = buttonGroup.append("text")
			.attr("class", "buttontext")
			.text("Folder")
			.attr("x", width *1.025)
			.attr("y", height * 0.596)
			.attr("dy", "" + .3 + "ex")
			.style("font-size",""+ width * 0.011 +"px")
			.style("fill", "Black")
			.on("click", function(d,i){location.href = "folderView.html";})
			.style("cursor", "pointer");
		
		///////////////////////
		// Define the pop-up //
		///////////////////////
		
		var div = d3.select("body").append("div")	
			.attr("class", "tooltip")
			.style("left", "10px")
			.style("top", "10px")
			.style("opacity", 0);
		
		var divDetail = d3.select("body").append("div")	
			.data(["details"])
			.attr("class", "detailview")
			.style("left", "10px")
			.style("top", "10px")
			.style("opacity", 0);
		
		/////////////////////////////////////////////////////////
		// Create a grid group and define the rows and columns //
		/////////////////////////////////////////////////////////
		
		var gridGroup = svg.append("g");
			
		var row = gridGroup.selectAll(".row")
			.data(matrix)
		  .enter().append("g")
			.attr("class", "row")
			.attr("transform", function(d, i) { return "translate(0," + y(i) + ")"; });
		
		row.selectAll(".cell")
			.data(function(d) { return d; })
		  .enter().append("rect")
			.attr("class", "cell")
			.attr("x", function(d, i) { return x(i); })
			.attr("width", x.rangeBand())
			.attr("height", y.rangeBand())
			.style("stroke-width", 0.5)
			.style("stroke", "black")
			.style("cursor","pointer")
			.on("click", function(d) {loadDetail(d);})
			.on("mouseover", function(d,i,j) {	
				row.selectAll(".cell")
					.filter(function(dx,ix,jx) { return (ix == i && jx == j); })
					.style("stroke-width", 2.5);
				div.transition()		
					.duration(200)		
					.style("opacity", .9);	
				div	.html("Row "+ j +": " + d[1] + "<br> Column " + i + ": " + d[2] + "<br> # clone pairs: " + d[0].toString())	
					.style("left", (d3.event.pageX) + "px")		
					.style("top", (d3.event.pageY - 70) + "px");	
			})					
			.on("mouseout", function(d,i,j) {
				row.selectAll(".cell")
					.filter(function(dx,ix,jx) { return (ix == i && jx == j); })
					.style("stroke-width", 0.5);
				div.transition()		
					.duration(500)		
					.style("opacity", 0);	
			});
		
		row.append("text")
			.attr("x", 0)
			.attr("y", y.rangeBand() / 2)
			.attr("dy", ".32em")
			.attr("dx", "-.64em")
			.attr("text-anchor", "end")
			.style("font-size", fontSize.toString() + "px")
			.text(function(d, i) { return d[i][1]; });
			
		var column = gridGroup.selectAll(".column")
			.data(matrix)
		  .enter().append("g")
			.attr("class", "column")
			.attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
		
		column.append("text")
			.attr("x", 6)
			.attr("y", y.rangeBand() / 2)
			.attr("dy", ".64em")
			.attr("text-anchor", "start")
			.style("font-size", fontSize.toString() + "px")
			.text(function(d, i) { return d[i][2]; });
		
		row.selectAll(".cell")
			.attr("fill", function(d) { return chooseColor(d); } );
		
		////////////////////////////////////////////
		// Define the legend of the visualization //
		////////////////////////////////////////////
		
		var legend = restGroup.selectAll(".legend")
		  .data([0,1,2,3,4,15]);
		
		legend.enter().append("g")
		  .attr("class", "legend");

		legend.append("rect")
			.attr("x", width + (gridSize / 2))
			.attr("y", function(d, i) { return legendElementWidth * i; })
			.attr("width", gridSize / 2)
			.attr("height", legendElementWidth)
			.style("stroke", "black")
			.style("fill", function(d, i) { return colors[i]; });

		legend.append("text")
			.attr("class", "mono")
			.text(function(d) { 
				if (d >= 4)
					return "≥ " + Math.round(d); 
				else 
					return Math.round(d);})
			.attr("dy", ".75em")
			.attr("x", width + (1.1*gridSize))
			.style("fill", "Black")
			.attr("y", function(d, i) { return (legendElementWidth* i); });

		///////////////////////////////////////
		// Update function for sorted matrix //
		///////////////////////////////////////
		
		function loadSorted() {
		
			var sortedData = matrix;
			
			if (sorted == false) {
				sorted = true;
				sortedData = sortMatrix(matrix);
				
				buttonGroup.selectAll("rect")
					.filter(function(d) { return (d == "clonesButton"); })
					.style("fill", "#1d91c0");
			} else {
				sorted = false;
				sortedData = matrix;
				
				buttonGroup.selectAll("rect")
					.style("fill", "#EBFCFF");
			}
			gridGroup.selectAll("g").remove();
			gridGroup.selectAll("rect").remove();
			gridGroup.selectAll("text").remove();
			
			var row = gridGroup.selectAll(".row")
				.data(sortedData)
			  .enter().append("g")
				.attr("class", "row")
				.attr("transform", function(d, i) { return "translate(0," + y(i) + ")"; });
			
			row.selectAll(".cell")
				.data(function(d) { return d; })
			  .enter().append("rect")
				.attr("class", "cell")
				.attr("x", function(d, i) { return x(i); })
				.attr("width", x.rangeBand())
				.attr("height", y.rangeBand())
				.style("stroke-width", 0.5)
				.style("stroke", "black")
				.style("cursor","pointer")
				.on("click", function(d) {loadDetail(d);})
				.on("mouseover", function(d,i,j) {	
					row.selectAll(".cell")
						.filter(function(dx,ix,jx) { return (ix == i && jx == j); })
						.style("stroke-width", 2.5);
					div.transition()		
						.duration(200)		
						.style("opacity", .9);		
					div	.html("Row "+ j +": " + d[1] + "<br> Column " + i + ": " + d[2] + "<br> # clone pairs: " + d[0].toString())	
						.style("left", (d3.event.pageX) + "px")		
						.style("top", (d3.event.pageY - 70) + "px");	
				})					
				.on("mouseout", function(d,i,j) {
					row.selectAll(".cell")
						.filter(function(dx,ix,jx) { return (ix == i && jx == j); })
						.style("stroke-width", 0.5);
					div.transition()		
						.duration(500)		
						.style("opacity", 0);	
				});
				
			row.append("text")
				.attr("x", 0)
				.attr("y", y.rangeBand() / 2)
				.attr("dy", ".32em")
				.attr("dx", "-.32em")
				.attr("text-anchor", "end")
				.style("font-size",fontSize.toString() + "px")
				.text(function(d, i) { return d[i][1]; });
				
			var column = gridGroup.selectAll(".column")
				.data(sortedData)
			  .enter().append("g")
				.attr("class", "column")
				.attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
			
			
			column.append("text")
				.attr("x", 6)
				.attr("y", y.rangeBand() / 2)
				.attr("dy", ".64em")
				.attr("text-anchor", "start")
				.style("font-size",fontSize.toString() + "px")
				.text(function(d, i) { return d[i][2]; });
			
			row.selectAll(".cell")
				.attr("fill", function(d) { return chooseColor(d); } );
		}
		
		/////////////////////////////////////////////////////////
		// Update and remove functions for getting cell detail //
		/////////////////////////////////////////////////////////
		
		function isEven(n) {
		   return n % 2 == 0;
		}

		function isOdd(n) {
		   return Math.abs(n % 2) == 1;
		}
		
		function splitLocations(locations) {
			var res = locations.split("|file:///C:/Users/vince/workspace/");

			if (res[0] == "[]")
				return "<strong>No clone pairs</strong>";
				
			var totalString = "<strong>Clone pair locations:</strong> <br>"
			var countPairs = 1;
			var count = 1;
			var pairSubString = "";
			for (var i = 1; i < res.length; i++) {
				var subString = "";
				if (i == (res.length - 1)) {
					subString = res[i].substring(0, res[i].length - 2);
				} else if (isOdd(i)){
					subString = res[i].substring(0, res[i].length - 1);
				} else {
					subString = res[i].substring(0, res[i].length - 3);
				}
				if(count == 1) {
					count += 1;
					pairSubString += ("<em>Pair " + countPairs.toString() + ":</em> <br>");
					pairSubString += ("|" + subString + "<br>");
				} else {
					count = 1;
					countPairs += 1;
					pairSubString += ("|" + subString + "<br><br>");
					totalString += pairSubString;
					pairSubString = "";
				}	
			}
			return totalString;
		}
		
		function createString(data) {
			var totalString = "<font size='6'><strong>Clone pair overview</strong></font> <br><br>";
			totalString += "<strong>Number of clone pairs:</strong> <br>"+ data[0].toString() + "<br><br>";
			totalString += "<strong>File names:</strong> <br>"+ data[1] + "<br>" + data[2] + "<br><br>";
			totalString += splitLocations(data[3]);
			return totalString;
		}
		function loadDetail(data) {
			
			divDetail.style("opacity", 1)
				.html(createString(data))
				.style("left", (d3.event.pageX + 50) + "px")		
				.style("top", "200px")
				.style("width", "380px")
				.style("height", "400px")
				.style("cursor", "pointer")
				.on("click", function() {removeDetail();
				});		
		
		}
		
		function removeDetail() {

			divDetail.style("opacity", 0)
				.attr("class", "detailview")
				.style("width", "0px")
				.style("height", "0px")
				.style("left", "0px")
				.style("top", "0px");
		}
			
	});
</script>